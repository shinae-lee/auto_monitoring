#!/usr/bin/env bash
set -euo pipefail

TARGET_FILE="${1:?사용법: $0 <파일경로> [OUT_DIR] [FOLLOW_LINES]}"
OUT_DIR="${2:-./log/jeus-exceptions}"
FOLLOW_LINES="${3:-5}"
ERROR_PATTERN='(Exception|ERROR)'

mkdir -p "$OUT_DIR"
OUT_FILE="${OUT_DIR}/exceptions-$(date +%F).log"

awk -v out="$OUT_FILE" -v pat="$ERROR_PATTERN" -v follow="$FOLLOW_LINES" '
{
  if ($0 ~ pat) {
    print "----- [" strftime("%Y-%m-%d %H:%M:%S") "] DETECTED -----" >> out
    print $0 >> out
    for (i=0; i<follow; i++) {
      if (getline nxt > 0) print nxt >> out; else break
    }
    print "" >> out
    fflush(out)
  }
}
' "$TARGET_FILE"

echo "완료: $OUT_FILE"
