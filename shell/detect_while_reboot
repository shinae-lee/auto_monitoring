#!/usr/bin/env bash
set -euo pipefail

LOG_FILE="${LOG_FILE:-./JeusServer.log}"
OUT_DIR="${OUT_DIR:-./log/jeus-exceptions}"

LOGGING_START='The JVM process will be terminated.'

ERROR_PATTERN='(Exception|ERROR)'

MONITOR_SECS="${MONITOR_SECS:-30}"
FOLLOW_LINES="${FOLLOW_LINES:-1}"
EXCLUDE_FILE="${EXCLUDE_FILE:-./exclude_exceptions.txt}"

if [ ! -d "$OUT_DIR" ]; then
  mkdir -p "$OUT_DIR"
fi

timeout "$MONITOR_SECS"s  tail -n +1 -F "$LOG_FILE" \
| gawk -v out_dir="$OUT_DIR" \
      -v start_pat="$LOGGING_START" \
      -v err_pat="$ERROR_PATTERN" \
      -v win_secs="$MONITOR_SECS" \
      -v follow="$FOLLOW_LINES" \
      -v exfile="$EXCLUDE_FILE" '
function outFile(ts) {
  return out_dir "/exceptions-" strftime("%Y-%m-%d_%H-%M-%S", ts) ".log"
}

BEGIN {
  print "Output directory: " out_dir > "/dev/stderr"
  window_end = 0
 
}

{ 
  sub(/[\r\n]+$/, "")
  now = systime()
  if (index($0, start_pat) > 0) {
    window_end = now + win_secs
    f = outFile(now)
    print "===== [WINDOW START " strftime("%Y-%m-%d %H:%M:%S", now) "] =====" >> f
    close(f)
  }

  exclude_re = ""

  # 제외 패턴 파일 읽어서 하나의 OR 정규식으로 결합
  if (exfile != "") {
    while ((getline line < exfile) > 0) {
      sub(/\r$/, "", line)        # CR 제거
      if (line ~ /^#/ || line ~ /^[[:space:]]*$/) continue
      
      # 제외 파일의 한 줄을 "문자 그대로" 매칭하도록 정규식 특수문자 이스케이프
      gsub(/[][(){}.^$*+?|\\-]/, "\\\\&", line)

      # OR 정규식으로 결합
      exclude_re = (exclude_re == "" ? line : exclude_re "|" line)
    }
    close(exfile)
    exclude_re = "(" exclude_re ")"  # 최종적으로 괄호로 감싸기
  }
  
  # 창이 열려있고 && 오류 패턴이 일치할 때
  if (now <= window_end && $0 ~ err_pat && (exclude_re == "" || $0 !~ exclude_re)) {
    f = outFile(now)
    print "----- [" strftime("%Y-%m-%d %H:%M:%S") "] DETECTED -----" >> f
    print $0 >> f

    for (i = 0; i < follow; i++) {
      if (getline nxt > 0) {
        print nxt >> f
      } else {
        break
      }
    }
    print "" >> f

    if (close(f) != 0) {
      print "WARN: close() failed for " f > "/dev/stderr"; fflush("/dev/stderr")
    }

  }
}
'


echo " ***** $MONITOR_SECS초 모니터링 후 자동 종료됨 *****"